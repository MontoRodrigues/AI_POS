<div class="container-fluid">
    <app-breadcrumb></app-breadcrumb>
    @if(!purchase){
        <h4 class="page-header"><a href="/purchase">Go back</a></h4>
    }


    @if(purchase){
    <!-- Add New Purchase List -->

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-xl p-6 sm:p-10">

        <!-- Header -->
        <header class="mb-8 border-b">
            <h1 class="text-2xl font-extrabold text-indigo-700">
                Purchase for {{purchase?.supplier?.name}}
                <span class="text-sm text-gray" style="display: block; font-weight: normal; font-size:12px">Created by
                    {{purchase?.createdBy}} on {{purchase?.purchaseDate| date:'dd MMM yy h:mm a'}} </span>
            </h1>
            <p class="text-gray-500 mt-1">Record items purchased from a supplier, validate prices, and confirm payment
                totals.</p>
        </header>

        <!-- Dynamic Purchase Item Entry Form -->

        <section class="mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2"
                style="display: flex;align-items: center;justify-content: space-between;">
                @if(product && !purchaseProduct.new){

                <div style="    display: flex;gap: 5px;align-items: center;">
                    <img src="{{product.image[0].downloadURL}}" style="max-width: 35px;">
                    <h4 class="text-base font-bold text-gray-900 truncate" style="max-width: 30vw;">{{product.name}}
                        ({{product.currentInventory}} )</h4>
                </div>                
                }
                @else{
                <span>Add New Items</span>
                }

                <div class="form-div">
                    <app-switch-btn [off_text]="'Existing'" [onn_text]="'New'"
                        [(value)]="purchaseProduct.new"></app-switch-btn>
                </div>
            </h2>




            <!-- Mobile-first layout: inputs stack, button is full width -->
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end" style="align-items: flex-start;">
                <!-- Product Bar Code Scan or Serch  -->
                @if(!purchaseProduct.new){
                <div class="md:col-span-3">
                    <!-- product bar code -->
                    <div class="form-div">
                        <label class="block text-sm font-medium text-gray-700">Scan or Type Barcode</label>
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Barcode"
                                [(ngModel)]="purchaseProduct.barcode">

                            <button class="btn btn-outline-secondary" type="button" (click)="searchBarcode()">
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" (click)="startScanner()">
                                <i class="fa-solid fa-qrcode"></i>
                            </button>
                            <!-- <button class="btn btn-outline-secondary" type="button" (click)="FindProduct()">
                                            <i class="fa-solid fa-folder-tree"></i>
                                        </button> -->
                        </div>
                        <div class="form-text">
                            You can enter the bar code manually or scan it .
                        </div>
                    </div>
                </div>
                }

                <!-- product name -->
                @if((!product && purchaseProduct.new) || purchaseProduct.new){
                <div class="md:col-span-3">

                    <div [class]="validatePurchaseProduct.productName">
                        <label class="block text-sm font-medium text-gray-700">Product Name</label>
                        <input type="text" class="form-control app-form-component" placeholder="Product Name"
                            [(ngModel)]="purchaseProduct.productName">
                        <div class="form-text">
                            Name of the product as mentioned on the packing
                        </div>
                        <span class="error-message">Please enter Category name</span>
                    </div>

                </div>
                }


                <!-- Inventory Purchase Price -->
                <div class="md:col-span-3">

                    <div [class]="validatePurchaseProduct.purchasePrice">
                        <label class="block text-sm font-medium text-gray-700">Purchase Price</label>

                        <div class="input-group flex-nowrap">
                            <span class="input-group-text"><i class="fa-solid fa-indian-rupee-sign"></i></span>
                            <input type="number" class="form-control app-form-component" placeholder="Purchase Price"
                                [(ngModel)]="purchaseProduct.purchasePrice">
                        </div>
                        <div class="form-text">
                            Please add the purchase price for the product for one unit
                        </div>
                        <span class="error-message">Please add purchase price</span>
                    </div>
                </div>


                <!-- MRP -->
                <div class="md:col-span-3">
                    <div [class]="validatePurchaseProduct.MRP">
                        <label class="block text-sm font-medium text-gray-700">MRP</label>

                        <div class="input-group flex-nowrap">
                            <span class="input-group-text"><i class="fa-solid fa-indian-rupee-sign"></i></span>
                            <input type="number" class="form-control app-form-component" placeholder="MRP"
                                [(ngModel)]="purchaseProduct.MRP">
                        </div>
                        <div class="form-text">
                            Please add the MRP for the product for one unit
                        </div>
                        <span class="error-message">Please add MRP</span>
                    </div>
                </div>

                <!-- Quantity -->
                <div class="md:col-span-3">
                    <div [class]="validatePurchaseProduct.quantity">
                        <label class="block text-sm font-medium text-gray-700">Inventory Quantity</label>

                        <div class="input-group flex-nowrap">
                            <input type="number" class="form-control app-form-component" placeholder="Quantity"
                                [(ngModel)]="purchaseProduct.quantity">
                            <span class="input-group-text">@if(product && !purchaseProduct.new ){ {{product.uom}} }
                                @else { # }</span>
                        </div>
                        <div class="form-text">
                            Add Quantity for the product in {{product?.uom}}
                        </div>
                        <span class="error-message">Please add Quantity</span>
                    </div>
                </div>




            </div>

            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end"
                style="align-items: center;     padding-top: 20px;">
                <!-- Image -->
                <div class="md:col-span-3">

                    <div [class]="validatePurchaseProduct.image">
                        <label class="block text-sm font-medium text-gray-700">Add Product Image</label>

                        <div class="image-container">
                            <app-image-upload imageWidth="400" imageHeight="400"
                                (imageReady)="onImageSelected($event)"></app-image-upload>

                            @if(image) {
                            <div class="image">

                                <img src="{{image.imageUrl}}">
                            </div>
                            }
                        </div>
                        <span class="error-message">Please add image</span>

                    </div>
                </div>
                <!-- Action Button (Full width on mobile, inline on tablet/desktop) -->
                <div class="md:col-span-3">
                    <button type="button" (click)="addPurchaseProduct()"
                        class="w-full py-2 px-4 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01] active:scale-100">
                        Add Item
                    </button>
                </div>
            </div>
        </section>



        <!-- Order Items Display - Mobile-First Layout -->
        <section class="mb-8 ">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Order Line Items</h2>

           
            <!-- 2. Prodduct Purchase list -->
            @if(purchase.purchase.length>0){
             <!-- 1. Desktop/Tablet View (Traditional Table) -->
            <div class="sm:block overflow-x-auto shadow-md rounded-xl desktop-only">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Product</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Price/Unit</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Previous Price/Unit</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                MRP</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Previous MRP</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Quantity</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Inventory</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Subtotal</th>
                            <th
                                class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        @for(p of purchase.purchase; track $index) {
                       <tr class="hover:bg-gray-50" >
                        <td style="position: relative; width: 10px;">
                            <div class="checkbox-wrapper-31" style="    top: 29px;left: 5px;">
                                <input type="checkbox" [(ngModel)]="p.reviewed" />
                                <svg viewBox="0 0 35.6 35.6">
                                    <circle class="background" cx="17.8" cy="17.8" r="17.8"></circle>
                                    <circle class="stroke" cx="17.8" cy="17.8" r="14.37"></circle>
                                    <polyline class="check" points="11.78 18.12 15.55 22.23 25.17 12.87"></polyline>
                                </svg>
                            </div>
                        </td>
                        <!-- Product -->
                        <td class="px-6 whitespace-nowrap text-sm font-medium text-gray-900">
                            <div style="position: relative; height: 80px; display: flex; align-items: center;">
                            
                            <img src="{{p.image?.downloadURL}}" style="height: 70px;">
                            <div class="font-semibold truncate" style="width: 100px;">{{p.productName}}</div>
                            </div>
                           
                        </td>
                        <!-- Price/Unit -->
                        <td class="px-6  whitespace-nowrap text-right text-sm text-gray-500">
                            @if(!p.edit){
                            <span class="font-medium">Rs. {{p.purchasePrice}}</span>
                            }
                            @if(p.edit){
                            <input type="number"
                                class="mt-1 w-full px-1 py-1 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Edit Purchase Price" [(ngModel)]="p.purchasePrice">
                            }
                        </td>
                        <!-- Previous Price/Unit -->
                         <td class="px-6  whitespace-nowrap text-right text-sm text-gray-500">                            
                            <span class="font-medium">
                                @if(p.previousPurchasePrice!=null){Rs. {{p.previousPurchasePrice}}}</span>
                        </td>

                        <!-- MRP -->
                        <td class="px-6  whitespace-nowrap text-right text-sm text-gray-500">
                           @if(!p.edit){
                            <span class="font-medium">Rs. {{p.MRP}}</span>
                            }
                            @if(p.edit){
                            <input type="number"
                                class="mt-1 w-full px-1 py-1 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Edit MRP" [(ngModel)]="p.MRP">
                            }
                        </td>

                        <!-- Previous MRP -->
                         <td class="px-6  whitespace-nowrap text-right text-sm text-gray-500">                           
                            <span class="font-medium">@if(p.PreviousMRP!=null){Rs. {{p.PreviousMRP}}}</span>                            
                        </td>

                        <!-- Quantity -->
                        <td class="px-6  whitespace-nowrap text-right text-sm text-gray-500">
                            @if(!p.edit){
                            <span class="font-medium">{{p.quantity}}</span>
                            }
                            @if(p.edit){
                            <input type="number"
                                class="mt-1 w-full px-1 py-1 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Edit Quantity" [(ngModel)]="p.quantity">
                            }
                        </td>

                        <!-- Inventory -->
                          <td class="px-6  whitespace-nowrap text-right text-sm text-gray-500">                           
                            <span class="font-medium">@if(p.currentInventory){ {{p.currentInventory}} }</span>                        
                        </td>

                    

                        <!-- Subtotal -->
                        <td class="px-6  whitespace-nowrap text-right text-sm font-bold text-gray-900">Rs. {{(p?.purchasePrice ?? 0) * (p?.quantity ?? 0)}}</td>
                        <!-- Action -->
                        <td class="px-6  whitespace-nowrap text-center text-sm space-x-2 flex justify-center items-center">
                 @if(!p.edit){
                            <button (click)="deletePurchaseProduct($index)"
                                class="text-red-600 hover:text-red-900 transition duration-150 p-1 rounded-full hover:bg-red-100 flex-shrink-0"
                                aria-label="Remove item">
                                <!-- Trash Icon -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>

                            <button (click)="editPurchaseProduct(p)"
                                class="text-red-600 hover:text-red-900 transition duration-150 p-1 rounded-full hover:bg-red-100 flex-shrink-0"
                                aria-label="Remove item">
                                <!-- Edit Icon -->
                                <svg _ngcontent-ng-c3991276113="" class="svg-inline--fa fa-pen-to-square"
                                    role="img" viewBox="0 0 512 512" >
                                    <path fill="currentColor"
                                        d="M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L368 46.1 465.9 144 490.3 119.6c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L432 177.9 334.1 80 172.4 241.7zM96 64C43 64 0 107 0 160L0 416c0 53 43 96 96 96l256 0c53 0 96-43 96-96l0-96c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7-14.3 32-32 32L96 448c-17.7 0-32-14.3-32-32l0-256c0-17.7 14.3-32 32-32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L96 64z">
                                    </path>
                                </svg>
                            </button>
                            }

                            @if(p.edit){

                             <button  (click)="savePurchaseProduct(p)"
                                class="text-red-600 hover:text-red-900 transition duration-150 p-1 rounded-full hover:bg-red-100 flex-shrink-0"
                                aria-label="Remove item">
                                <!-- Save -->
                                <svg class="svg-inline--fa fa-pen-to-square" viewBox="0 0 32 32" version="1.1">    
                                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage">
                                        <g sketch:type="MSLayerGroup" transform="translate(-152.000000, -515.000000)" fill="currentColor">
                                            <path
                                                d="M171,525 C171.552,525 172,524.553 172,524 L172,520 C172,519.447 171.552,519 171,519 C170.448,519 170,519.447 170,520 L170,524 C170,524.553 170.448,525 171,525 L171,525 Z M182,543 C182,544.104 181.104,545 180,545 L156,545 C154.896,545 154,544.104 154,543 L154,519 C154,517.896 154.896,517 156,517 L158,517 L158,527 C158,528.104 158.896,529 160,529 L176,529 C177.104,529 178,528.104 178,527 L178,517 L180,517 C181.104,517 182,517.896 182,519 L182,543 L182,543 Z M160,517 L176,517 L176,526 C176,526.553 175.552,527 175,527 L161,527 C160.448,527 160,526.553 160,526 L160,517 L160,517 Z M180,515 L156,515 C153.791,515 152,516.791 152,519 L152,543 C152,545.209 153.791,547 156,547 L180,547 C182.209,547 184,545.209 184,543 L184,519 C184,516.791 182.209,515 180,515 L180,515 Z"
                                                sketch:type="MSShapeGroup">                                    
                                            </path>
                                        </g>
                                    </g>
                                </svg>      
                            </button>

                            <button (click)="cancelEditPurchaseProduct(p)"
                                class="text-red-600 hover:text-red-900 transition duration-150 p-1 rounded-full hover:bg-red-100 flex-shrink-0"
                                aria-label="Remove item">
                                <!-- Cancel -->

                                <svg class="svg-inline--fa fa-pen-to-square" fill="currentColor" viewBox="0 0 32 32" version="1.1">
                                    <path
                                        d="M10.771 8.518c-1.144 0.215-2.83 2.171-2.086 2.915l4.573 4.571-4.573 4.571c-0.915 0.915 1.829 3.656 2.744 2.742l4.573-4.571 4.573 4.571c0.915 0.915 3.658-1.829 2.744-2.742l-4.573-4.571 4.573-4.571c0.915-0.915-1.829-3.656-2.744-2.742l-4.573 4.571-4.573-4.571c-0.173-0.171-0.394-0.223-0.657-0.173v0zM16 1c-8.285 0-15 6.716-15 15s6.715 15 15 15 15-6.716 15-15-6.715-15-15-15zM16 4.75c6.213 0 11.25 5.037 11.25 11.25s-5.037 11.25-11.25 11.25-11.25-5.037-11.25-11.25c0.001-6.213 5.037-11.25 11.25-11.25z" />
                                </svg>
                            </button>                           
                            }
                        </td>
                    </tr>
                }
                    </tbody>
                </table>
            </div>

            <div class="sm:block space-y-4 mobile-only">
                <!-- Mobile cards will be inserted here by JS -->
                @for(p of purchase.purchase; track $index) {
                <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm" style="background-image: url({{p.image?.downloadURL}}); padding: 10px !important; background-size: cover;">
                    <div style="    background-color: rgba(255, 255, 255, .7); padding: 14px; border-radius: 8px;">
                    <div class="flex justify-between items-center mb-2 border-b pb-2">
                        <h4 class="text-base font-bold text-gray-900 truncate"
                            style="padding-left: 30px; position: relative;">
                            <div class="checkbox-wrapper-31">
                                <input type="checkbox" [(ngModel)]="p.reviewed" />
                                <svg viewBox="0 0 35.6 35.6">
                                    <circle class="background" cx="17.8" cy="17.8" r="17.8"></circle>
                                    <circle class="stroke" cx="17.8" cy="17.8" r="14.37"></circle>
                                    <polyline class="check" points="11.78 18.12 15.55 22.23 25.17 12.87"></polyline>
                                </svg>
                            </div>
                            <span class="truncate" style="max-width: 30vw; display: block;"> {{p.productName}}</span>
                        </h4>
                        <div style="display: flex;align-items: center;justify-content: center;">
                            @if(!p.edit){
                            <button (click)="deletePurchaseProduct($index)"
                                class="text-red-600 hover:text-red-900 transition duration-150 p-1 rounded-full hover:bg-red-100 flex-shrink-0"
                                aria-label="Remove item">
                                <!-- Trash Icon -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>

                            <button (click)="editPurchaseProduct(p)"
                                class="text-red-600 hover:text-red-900 transition duration-150 p-1 rounded-full hover:bg-red-100 flex-shrink-0"
                                aria-label="Remove item">
                                <!-- Edit Icon -->
                                <svg _ngcontent-ng-c3991276113="" class="svg-inline--fa fa-pen-to-square"
                                    role="img" viewBox="0 0 512 512" >
                                    <path fill="currentColor"
                                        d="M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L368 46.1 465.9 144 490.3 119.6c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L432 177.9 334.1 80 172.4 241.7zM96 64C43 64 0 107 0 160L0 416c0 53 43 96 96 96l256 0c53 0 96-43 96-96l0-96c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7-14.3 32-32 32L96 448c-17.7 0-32-14.3-32-32l0-256c0-17.7 14.3-32 32-32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L96 64z">
                                    </path>
                                </svg>
                            </button>
                            }

                            @if(p.edit){

                             <button  (click)="savePurchaseProduct(p)"
                                class="text-red-600 hover:text-red-900 transition duration-150 p-1 rounded-full hover:bg-red-100 flex-shrink-0"
                                aria-label="Remove item">
                                <!-- Save -->
                                <svg class="svg-inline--fa fa-pen-to-square" viewBox="0 0 32 32" version="1.1">    
                                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage">
                                        <g sketch:type="MSLayerGroup" transform="translate(-152.000000, -515.000000)" fill="currentColor">
                                            <path
                                                d="M171,525 C171.552,525 172,524.553 172,524 L172,520 C172,519.447 171.552,519 171,519 C170.448,519 170,519.447 170,520 L170,524 C170,524.553 170.448,525 171,525 L171,525 Z M182,543 C182,544.104 181.104,545 180,545 L156,545 C154.896,545 154,544.104 154,543 L154,519 C154,517.896 154.896,517 156,517 L158,517 L158,527 C158,528.104 158.896,529 160,529 L176,529 C177.104,529 178,528.104 178,527 L178,517 L180,517 C181.104,517 182,517.896 182,519 L182,543 L182,543 Z M160,517 L176,517 L176,526 C176,526.553 175.552,527 175,527 L161,527 C160.448,527 160,526.553 160,526 L160,517 L160,517 Z M180,515 L156,515 C153.791,515 152,516.791 152,519 L152,543 C152,545.209 153.791,547 156,547 L180,547 C182.209,547 184,545.209 184,543 L184,519 C184,516.791 182.209,515 180,515 L180,515 Z"
                                                sketch:type="MSShapeGroup">                                    
                                            </path>
                                        </g>
                                    </g>
                                </svg>      
                            </button>

                            <button (click)="cancelEditPurchaseProduct(p)"
                                class="text-red-600 hover:text-red-900 transition duration-150 p-1 rounded-full hover:bg-red-100 flex-shrink-0"
                                aria-label="Remove item">
                                <!-- Cancel -->

                                <svg class="svg-inline--fa fa-pen-to-square" fill="currentColor" viewBox="0 0 32 32" version="1.1">
                                    <path
                                        d="M10.771 8.518c-1.144 0.215-2.83 2.171-2.086 2.915l4.573 4.571-4.573 4.571c-0.915 0.915 1.829 3.656 2.744 2.742l4.573-4.571 4.573 4.571c0.915 0.915 3.658-1.829 2.744-2.742l-4.573-4.571 4.573-4.571c0.915-0.915-1.829-3.656-2.744-2.742l-4.573 4.571-4.573-4.571c-0.173-0.171-0.394-0.223-0.657-0.173v0zM16 1c-8.285 0-15 6.716-15 15s6.715 15 15 15 15-6.716 15-15-6.715-15-15-15zM16 4.75c6.213 0 11.25 5.037 11.25 11.25s-5.037 11.25-11.25 11.25-11.25-5.037-11.25-11.25c0.001-6.213 5.037-11.25 11.25-11.25z" />
                                </svg>
                            </button>                           
                            }

                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 text-sm">
                        <div class="col-span-1">
                            <span class="text-gray-500 block">Price:</span>
                            @if(!p.edit){
                            <span class="font-medium">Rs. {{p.purchasePrice}}
                                @if(p.previousPurchasePrice!=null){({{p.previousPurchasePrice}})}</span>
                            }
                            @if(p.edit){
                            <input type="number"
                                class="mt-1 w-full px-1 py-1 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Edit Purchase Price" [(ngModel)]="p.purchasePrice">
                            }
                        </div>
                        <div class="col-span-1">
                            <span class="text-gray-500 block">MRP:</span>
                            @if(!p.edit){
                            <span class="font-medium">Rs. {{p.MRP}} @if(p.PreviousMRP!=null){({{p.PreviousMRP}})}</span>
                            }
                            @if(p.edit){
                            <input type="number"
                                class="mt-1 w-full px-1 py-1 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Edit MRP" [(ngModel)]="p.MRP">
                            }
                        </div>
                        <div class="col-span-1">
                            <span class="text-gray-500 block">Qty:</span>
                            @if(!p.edit){
                            <span class="font-medium">{{p.quantity}} @if(p.currentInventory){ ({{p.currentInventory}}) }</span>
                            }
                            @if(p.edit){
                            <input type="number"
                                class="mt-1 w-full px-1 py-1 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Edit Quantity" [(ngModel)]="p.quantity">
                            }
                        </div>
                        <div class="col-span-2 text-right" style="    flex-direction: row;display: flex;gap: 5px;">
                            <span class="text-gray-500 block">Subtotal:</span>
                            <span class="font-bold text-indigo-600">Rs. {{ (p?.purchasePrice ?? 0) * (p?.quantity ?? 0)
                                }}</span>
                        </div>
                    </div>
                    </div>
                </div>
                }

            </div>
            }

            @if(purchase.purchase.length==0){
            <!-- Single empty message for both views -->
            <div  class="mt-4 p-4 text-center text-gray-500 italic bg-gray-50 rounded-lg border">
                No items added to the purchase order yet.
            </div>
            }

        </section>

        <!-- Order Summary & Actions (Already responsive: stacks on mobile) -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6  ">

            <!-- Summary Card -->
            <div class="md:col-span-2 bg-indigo-50 p-6 rounded-xl shadow-lg border-l-4 border-indigo-600">
                <h3 class="text-lg font-bold text-indigo-800 mb-3">Order Totals</h3>

                <div class="space-y-2">
                    <div class="flex justify-between items-center text-gray-700">
                        <span>Total Items Purchased:</span>
                        <span id="totalQuantityDisplay" class="text-xl font-semibold">{{totalQuantity}}</span>
                    </div>

                    <div class="flex justify-between items-center text-gray-700 border-t border-indigo-200 pt-2">
                        <span class="text-2xl font-bold" style="font-size: 1.2rem;line-height: 1.5rem;">Total
                            Payable:</span>
                        <span style="font-size: 1.5rem;"
                            class="text-3xl font-extrabold text-indigo-800">Rs.{{totalPrice}}</span>
                    </div>
                </div>
            </div>

            <!-- Confirmation Action -->
            <div class="md:col-span-1 flex items-center">
                <button (click)="validateClosePurchase()"
                    class="w-full py-4 px-4 bg-green-600 text-white text-lg font-extrabold rounded-xl shadow-lg hover:bg-green-700 transition duration-150 transform hover:scale-[1.02] active:scale-100 disabled:opacity-50 disabled:cursor-not-allowed">
                    Confirm & Pay Supplier
                </button>
            </div>
        </section>

        <!-- Dynamic Message Box -->
        <div id="messageBox" class="mt-6 p-4 text-center rounded-lg hidden">
            <!-- Messages will appear here -->
        </div>

    </div>

    }


</div>